{% block content %}
<style>
  * {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .form-container {
    max-width: 600px;
    margin: 40px auto;
    padding: 30px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin-bottom: 40px;
  }

  form {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
  }

  label {
    flex: 1 1 45%;
    font-weight: 600;
    color: #444;
  }

  input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-top: 4px;
  }

  button {
    background-color: #4f46e5;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 20px;
  }

  button:hover {
    background-color: #4338ca;
  }

  h2, h3 {
    text-align: center;
    color: #333;
  }

  .circle-sim {
    position: relative;
    width: 500px;
    height: 500px;
    margin: 0 auto;
    border-radius: 50%;
    background-color: #e0d1b2;
  }

  .philosopher, .fork {
    position: absolute;
    text-align: center;
    font-weight: bold;
    border-radius: 50%;
    border: 1px solid #000;
  }

  .philosopher {
    width: 80px;
    height: 80px;
    line-height: 80px;
    background-color: #ddd;
  }

  .fork {
    width: 30px;
    height: 30px;
    line-height: 30px;
    background-color: #ccc;
  }

  .status {
    margin-top: 30px;
    text-align: center;
  }
</style>

<div class="form-container">
  <h2>Dining Philosophers Simulation</h2>
  <form method="post">
    {% csrf_token %}
    <label>
      Number of philosophers:
      <input type="number" name="n" value="{{ n }}" min="2" max="20">
    </label>
    <label>
      Iterations:
      <input type="number" name="iterations" value="{{ iterations }}" min="1">
    </label>
    <button type="submit">Run</button>
  </form>
</div>

{% if logs %}
  <div class="status">
    <h3>Output:</h3>
    <div class="circle-sim" id="circle-sim">
      <!-- Los filÃ³sofos y tenedores se generan con JS -->
    </div>
    <button onclick="nextStep()" style="margin-top: 20px;">Next</button>
  </div>

  <script>
    const n = {{ n }};
    let currentStep = 0;
    const logs = {{ logs|safe }};
    const container = document.getElementById("circle-sim");

    const radius = 200;
    const centerX = 250;
    const centerY = 250;

    const philosophers = [];
    const forks = [];

    function createCircle() {
      for (let i = 0; i < n; i++) {
        const angle = (2 * Math.PI / n) * i;
        const x = centerX + radius * Math.cos(angle) - 40;
        const y = centerY + radius * Math.sin(angle) - 40;

        const p = document.createElement("div");
        p.className = "philosopher";
        p.id = "phil" + i;
        p.textContent = "P" + i;
        p.style.left = x + "px";
        p.style.top = y + "px";
        container.appendChild(p);

        const fx = centerX + (radius - 60) * Math.cos(angle + Math.PI / n) - 15;
        const fy = centerY + (radius - 60) * Math.sin(angle + Math.PI / n) - 15;

        const f = document.createElement("div");
        f.className = "fork";
        f.id = "fork" + i;
        f.textContent = "F" + i;
        f.style.left = fx + "px";
        f.style.top = fy + "px";
        container.appendChild(f);
      }
    }

    function resetColors() {
      for (let i = 0; i < n; i++) {
        document.getElementById("phil" + i).style.backgroundColor = "#ddd";
        document.getElementById("fork" + i).style.backgroundColor = "#ccc";
      }
    }

    function nextStep() {
      if (currentStep >= logs.length) return;

      const line = logs[currentStep];
      const eatingMatch = line.match(/Philosopher (\d+) .*eating/);
      const hungryMatch = line.match(/Philosopher (\d+) is hungry/);
      const thinkingMatch = line.match(/Philosopher (\d+) is thinking/);

      if (eatingMatch) {
        const i = parseInt(eatingMatch[1]);
        document.getElementById("phil" + i).style.backgroundColor = "#ff0000";
        document.getElementById("fork" + i).style.backgroundColor = "#ff0000";
        document.getElementById("fork" + ((i + 1) % n)).style.backgroundColor = "#ff0000";
      } else if (hungryMatch) {
        const i = parseInt(hungryMatch[1]);
        document.getElementById("phil" + i).style.backgroundColor = "#ffff00";
      } else if (thinkingMatch) {
        const i = parseInt(thinkingMatch[1]);
        document.getElementById("phil" + i).style.backgroundColor = "#ccc";
      }

      currentStep++;
    }

    createCircle();
  </script>
{% endif %}
{% endblock %}
